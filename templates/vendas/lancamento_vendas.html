{% extends "base.html" %}
{% load static %}

{% block title %}Lan√ßar Nova Venda{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <h1 class="mb-4">üí∞ Lan√ßamento de Vendas</h1>
        
        <form id="formVendas" method="POST" action="{% url 'vendas_lancar' %}">
            {% csrf_token %}

            <div class="card mb-3">
                <div class="card-header bg-primary text-white">1. Cliente e Hist√≥rico</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="id_cliente_input" class="form-label">Nome do Cliente / ID</label>
                        <input type="text" class="form-control" id="id_cliente_input" placeholder="Digite o nome ou ID">
                        <input type="hidden" name="cliente" id="id_cliente_hidden"> 
                        <small class="form-text text-muted">Aguardando busca...</small>
                    </div>
                    
                    <div id="feedback-cliente" class="alert alert-info" style="display:none;">
                        <p>Cliente: <strong id="feedback-nome"></strong></p>
                        <p>Cashback Dispon√≠vel: <strong id="feedback-cashback" class="text-success"></strong></p>
                        <p>D√≠vidas em Aberto: <strong id="feedback-divida" class="text-danger"></strong></p>
                        <div id="opcoes-cliente">
                            </div>
                    </div>
                    
                    <div id="feedback-novo-cliente" class="mt-3" style="display:none;">
                        <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalCadastroRapido">
                            + Cadastrar Cliente e Continuar
                        </button>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">2. Detalhes da Venda</div>
                <div class="card-body">
                    
                    <div class="mb-3">
                        <label for="id_data_venda" class="form-label">Data e Hora da Venda *</label>
                        <input type="datetime-local" class="form-control" id="id_data_venda" name="data_venda" required value="{{ data_venda_default }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_valor_total" class="form-label">Valor Total da Venda</label>
                        <input type="number" step="0.01" class="form-control" id="id_valor_total" name="valor_total" required value="0.00">
                    </div>

                    <div class="mb-3">
                        <label for="id_cashback_a_receber" class="form-label text-primary">Cashback a Receber (3% da Venda)</label>
                        <input type="text" class="form-control" id="id_cashback_a_receber" name="valor_cashback_gerado" value="0.00" readonly>
                    </div>

                    <div class="mb-3">
                        <label for="id_cashback_utilizado" class="form-label">Valor de Cashback Resgatado</label>
                        <input type="number" step="0.01" class="form-control" id="id_cashback_utilizado" name="valor_cashback_utilizado" value="0.00" readonly>
                    </div>

                    <div class="mb-3">
                        <label for="id_valor_final" class="form-label">Valor Final a Pagar (R$) (Total - Resgate)</label>
                        <input type="text" class="form-control" id="id_valor_final" name="valor_final_a_pagar" readonly value="0.00">
                    </div>

                    <div class="mb-3">
                        <label for="id_forma_pagamento" class="form-label">Forma de Pagamento</label>
                        <select class="form-select" id="id_forma_pagamento" name="forma_pagamento" required>
                            <option value="">Selecione a Forma</option>
                            {% for forma in formas_pagamento %}
                                <option value="{{ forma.id }}">{{ forma.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_status_pagamento" class="form-label">Status do Pagamento</label>
                        <select class="form-select" id="id_status_pagamento" name="status_pagamento" required>
                            <option value="PAGO">Pago (Entrada Imediata)</option>
                            <option value="PENDENTE">Pendente (Conta a Receber, com data)</option>
                            <option value="DIVIDA">D√≠vida (Sem data prevista)</option>
                        </select>
                    </div>

                    <div class="mb-3" id="campo-data-vencimento" style="display:none;">
                        <label for="id_data_vencimento" class="form-label">Data de Vencimento</label>
                        <input type="date" class="form-control" id="id_data_vencimento" name="data_vencimento">
                    </div>

                </div>
            </div>

            <button type="submit" class="btn btn-success btn-lg">Finalizar e Lan√ßar Venda</button>
        </form>
    </div>
</div>

<div class="modal fade" id="modalCadastroRapido" tabindex="-1" aria-labelledby="modalCadastroRapidoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCadastroRapidoLabel">Cadastro R√°pido de Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formCadastroRapido">
                    <div class="mb-3">
                        <label for="novo_cliente_nome" class="form-label">Nome *</label>
                        <input type="text" class="form-control" id="novo_cliente_nome" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="novo_cliente_sobrenome" class="form-label">Sobrenome</label>
                        <input type="text" class="form-control" id="novo_cliente_sobrenome">
                    </div>

                    <div class="mb-3">
                        <label for="novo_cliente_apelido" class="form-label">Apelido</label>
                        <input type="text" class="form-control" id="novo_cliente_apelido">
                    </div>
                    
                    <div class="mb-3">
                        <label for="novo_cliente_telefone" class="form-label">Telefone</label>
                        <input type="text" class="form-control" id="novo_cliente_telefone">
                    </div>
                    
                    <div class="mb-3">
                        <label for="novo_cliente_email" class="form-label">E-mail</label>
                        <input type="email" class="form-control" id="novo_cliente_email">
                    </div>
                    
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="btnSalvarCliente">Salvar e Selecionar</button>
            </div>
        </div>
    </div>
</div>

{% endblock content %} 
{% block extra_js %}
<script>
    // URL para a sua view de busca AJAX
    const searchUrl = "{% url 'vendas_buscar_cliente_ajax' %}";
    const cadastroUrl = "{% url 'clientes_cadastro_rapido_ajax' %}";
    
    // --- ELEMENTOS DO DOM ---
    const clienteInput = document.getElementById('id_cliente_input');
    const clienteHidden = document.getElementById('id_cliente_hidden');
    const feedbackArea = document.getElementById('feedback-cliente');
    const novoClienteFeedback = document.getElementById('feedback-novo-cliente');
    const statusPagamentoSelect = document.getElementById('id_status_pagamento');
    const campoDataVencimento = document.getElementById('campo-data-vencimento');

    // Elementos de C√°lculo
    const valorTotalInput = document.getElementById('id_valor_total');
    const cashbackReceberInput = document.getElementById('id_cashback_a_receber');
    const cashbackUtilizadoInput = document.getElementById('id_cashback_utilizado');
    const valorFinalInput = document.getElementById('id_valor_final');
    
    const btnSalvarCliente = document.getElementById('btnSalvarCliente');
    const modalCadastroRapido = new bootstrap.Modal(document.getElementById('modalCadastroRapido'));

    // --- REGRAS DE NEG√ìCIO ---
    const TAXA_CASHBACK = 0.03; 
    const VALOR_MINIMO_RESGATE = 20.00; // Regra: R$ 20.00
    let debounceTimer;

    // =============================================================
    // FUN√á√ïES DE C√ÅLCULO E L√ìGICA DE NEG√ìCIO
    // =============================================================

    function calcularCashbackAReceber() {
        const valorTotalVenda = parseFloat(valorTotalInput.value) || 0;
        const cashbackReceber = valorTotalVenda * TAXA_CASHBACK;
        cashbackReceberInput.value = cashbackReceber.toFixed(2);
    }

    function calcularValorFinal() {
        calcularCashbackAReceber();
        
        const valorTotalVenda = parseFloat(valorTotalInput.value) || 0;
        const cashbackUtilizado = parseFloat(cashbackUtilizadoInput.value) || 0;
        
        const valorFinal = valorTotalVenda - cashbackUtilizado;
        valorFinalInput.value = Math.max(0, valorFinal).toFixed(2);
    }

    // --- L√ìGICA DE RESGATE DE CASHBACK (COM REGRAS) ---
    function resgatarCashback(saldoDisponivel) {
        const valorTotalVenda = parseFloat(valorTotalInput.value) || 0;
        
        // 1. REGRA M√çNIMA: Deve ter R$ 20,00 ou mais para resgatar.
        if (saldoDisponivel < VALOR_MINIMO_RESGATE) {
            alert(`N√£o √© poss√≠vel resgatar. Saldo m√≠nimo exigido √© R$ ${VALOR_MINIMO_RESGATE.toFixed(2)}.`);
            return;
        }
        
        // 2. REGRA M√ÅXIMA: N√£o pode ultrapassar 50% do valor da venda.
        const limiteMaximoVenda = valorTotalVenda * 0.50;
        
        let valorResgate = Math.min(saldoDisponivel, limiteMaximoVenda, valorTotalVenda);
        
        if (valorResgate < 0.01) {
             alert("O valor da venda √© muito baixo para aplicar resgate com base na regra de 50%.");
             return;
        }

        cashbackUtilizadoInput.value = valorResgate.toFixed(2);
        calcularValorFinal();

        alert(`Resgate aplicado! Valor: R$ ${valorResgate.toFixed(2)} (Limite: 50% da venda).`);
    }

    // --- EXIBIR CAMPO DE DATA PARA VENDAS PENDENTES ---
    statusPagamentoSelect.addEventListener('change', (e) => {
        if (e.target.value === 'PENDENTE') {
            campoDataVencimento.style.display = 'block';
        } else {
            campoDataVencimento.style.display = 'none';
        }
    });

    // =============================================================
    // FUN√á√ïES DE LOOKUP (AJAX) - AJUSTADA PARA BUSCA POR NOME
    // =============================================================

    function searchClient(query) {
        const termoBusca = query.trim(); 

        if (!termoBusca) {
            feedbackArea.style.display = 'none';
            novoClienteFeedback.style.display = 'none';
            return;
        }

        // Envia o termo de busca literal (nome/ID)
        fetch(`${searchUrl}?query=${termoBusca}`) 
            .then(response => response.json())
            .then(data => {
                feedbackArea.style.display = 'block';
                novoClienteFeedback.style.display = 'none';
                document.getElementById('opcoes-cliente').innerHTML = ''; 
                
                // Tratamento de seguran√ßa
                const saldoCashback = parseFloat(data.saldo_cashback || 0);
                const dividaTotal = parseFloat(data.divida_total || 0);
                const nomeSugerido = data.nome_sugerido || termoBusca; 

                if (data.encontrado) {
                    // CLIENTE ENCONTRADO
                    document.getElementById('feedback-nome').textContent = data.nome;
                    document.getElementById('feedback-cashback').textContent = `R$ ${saldoCashback.toFixed(2)}`;
                    document.getElementById('feedback-divida').textContent = `R$ ${dividaTotal.toFixed(2)}`;
                    clienteHidden.value = data.id; 

                    // Apresenta Op√ß√µes de A√ß√£o
                    let opcoesHtml = "";
                    if (dividaTotal > 0) {
                        opcoesHtml += `<button type="button" class="btn btn-sm btn-danger me-2" onclick="alert('Funcionalidade de Quitar D√≠vida ser√° implementada!')">Quitar D√≠vida (R$ ${dividaTotal.toFixed(2)})</button>`;
                    }
                    if (saldoCashback >= VALOR_MINIMO_RESGATE) {
                        opcoesHtml += `<button type="button" class="btn btn-sm btn-success" onclick="resgatarCashback(${saldoCashback})">Usar Cashback</button>`;
                    } else if (saldoCashback > 0) {
                        opcoesHtml += `<span class="badge bg-warning text-dark">R$ ${saldoCashback.toFixed(2)} - M√≠nimo R$ ${VALOR_MINIMO_RESGATE.toFixed(2)}</span>`;
                    }
                    document.getElementById('opcoes-cliente').innerHTML = opcoesHtml;

                } else {
                    // CLIENTE N√ÉO ENCONTRADO (Sugere cadastro)
                    feedbackArea.style.display = 'none';
                    novoClienteFeedback.style.display = 'block';
                    clienteHidden.value = '';
                    
                    document.getElementById('novo_cliente_nome').value = nomeSugerido; 
                }
            })
            .catch(error => console.error('Erro na busca AJAX:', error));
    }

    // =============================================================
    // L√ìGICA DO CADASTRO R√ÅPIDO (COM NOVOS CAMPOS)
    // =============================================================

    btnSalvarCliente.addEventListener('click', () => {
        const nome = document.getElementById('novo_cliente_nome').value.trim();
        
        // COLETANDO OS DADOS DOS NOVOS CAMPOS DO MODAL
        const sobrenome = document.getElementById('novo_cliente_sobrenome').value.trim();
        const apelido = document.getElementById('novo_cliente_apelido').value.trim();
        const telefone = document.getElementById('novo_cliente_telefone').value.trim();
        const email = document.getElementById('novo_cliente_email').value.trim();
        
        if (!nome) {
            alert("Por favor, digite o nome do cliente.");
            return;
        }

        // Chamada AJAX para a view de cadastro r√°pido
        const formData = new FormData();
        formData.append('nome', nome);
        
        // ADICIONA OS CAMPOS OPCIONAIS AO FormData
        formData.append('sobrenome', sobrenome);
        formData.append('apelido', apelido);
        formData.append('telefone', telefone);
        formData.append('email', email);

        // Adiciona o token CSRF para seguran√ßa do Django (essencial para POST)
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(cadastroUrl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                alert(`Cliente ${data.nome} cadastrado com sucesso!`);
                modalCadastroRapido.hide();

                // SUCESSO: For√ßa uma nova consulta para carregar o feedback do novo cliente
                searchClient(data.id); 
                
                // Limpa os campos do modal para o pr√≥ximo uso
                document.getElementById('novo_cliente_nome').value = ''; 
                document.getElementById('novo_cliente_sobrenome').value = '';
                document.getElementById('novo_cliente_apelido').value = '';
                document.getElementById('novo_cliente_telefone').value = '';
                document.getElementById('novo_cliente_email').value = '';
                
            } else {
                alert(`Falha no cadastro: ${data.mensagem}`);
            }
        })
        .catch(error => console.error("Erro de comunica√ß√£o com o servidor:", error));
    });


    // =============================================================
    // INICIALIZA√á√ÉO E EVENTOS
    // =============================================================

    // Evento de Debounce no campo de Cliente
    clienteInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            searchClient(e.target.value);
        }, 500); 
    });

    // Evento principal para calcular valores
    valorTotalInput.addEventListener('input', calcularValorFinal);
    
    // Inicializa o c√°lculo ao carregar a p√°gina
    document.addEventListener('DOMContentLoaded', calcularValorFinal); 

</script>
{% endblock extra_js %}